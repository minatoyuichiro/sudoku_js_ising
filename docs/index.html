<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <title>QUBO Sudoku Solver</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <style>
        body { font-family: 'Courier New', Courier, monospace; background-color: #f8f9fa; }
        .table-bordered { border: 3px solid black !important; background-color: white; margin: 0 auto; }
        .table-bordered tr:nth-child(3n) { border-bottom: 3px solid black !important; }
        .table-bordered td:nth-child(3n) { border-right: 3px solid black !important; }
        .table td { padding: 0; width: 50px; height: 50px; font-size: 2rem; position: relative; border: 1px solid #ccc; }
        input { border: 0; background: transparent; text-align: center; font-weight: bold; width: 100%; height: 100%; outline: none; }
        .answer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; line-height: 50px; text-align: center; font-weight: bold; color: skyblue; pointer-events: none; }
        .btn-custom { font-size: 24px; font-weight: bold; border: 3px solid black; margin: 5px; }
    </style>
</head>
<body>

<div class="container text-center" style="margin-top:20px">
    <table class="table table-bordered" id="main"></table>
    <div class="mt-3">
        <button id="sudoku" class="btn btn-outline-dark btn-custom">SOLVE</button>
        <button onclick="location.reload();" class="btn btn-outline-dark btn-custom">CLEAR</button>
    </div>
    <div id="status" class="mt-2" style="font-weight: bold; height: 30px;">Ready</div>
</div>

<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="bqubo.js"></script>

<script>
$(function(){
    // マス目生成
    for(var i=0; i<9; i++){
        var row = '<tr>';
        for(var j=0; j<9; j++){
            row += `<td id="cell_${i}_${j}"><input type="number" id="input_${i}_${j}">` +
                   (Array.from({length: 9}, (_, k) => `<div class="answer" id="answer_${i}_${j}_${k+1}"></div>`).join('')) + `</td>`;
        }
        $('#main').append(row + '</tr>');
    }

    $('#sudoku').click(async function(){
        const $btn = $(this).prop('disabled', true);
        const qubo = {};
        
        // --- 重みのバランス調整 ---
        const L_SELECT = 15.0; // マス埋め優先
        const L_CONSTRAINT = 8.0; // 重複禁止
        const L_FIXED = 30.0;    // 固定値（ヒント）

        const addQ = (i, j, w) => {
            const key = i < j ? i + ',' + j : j + ',' + i;
            qubo[key] = (qubo[key] || 0) + w;
        };

        // QUBO構築
        for (let n = 0; n < 81; n++) {
            for (let k = 0; k < 9; k++) {
                const idx = n * 9 + k;
                addQ(idx, idx, -1 * L_SELECT); 
                for (let k2 = k + 1; k2 < 9; k2++) addQ(idx, n * 9 + k2, 2 * L_SELECT);
            }
        }
        for (let k = 0; k < 9; k++) {
            for (let i = 0; i < 9; i++) {
                for (let j = 0; j < 9; j++) {
                    for (let m = j + 1; m < 9; m++) {
                        addQ((i * 9 + j) * 9 + k, (i * 9 + m) * 9 + k, 2 * L_CONSTRAINT);
                        addQ((j * 9 + i) * 9 + k, (m * 9 + i) * 9 + k, 2 * L_CONSTRAINT);
                    }
                }
            }
            for (let br = 0; br < 3; br++) {
                for (let bc = 0; bc < 3; bc++) {
                    let cells = [];
                    for (let r = 0; r < 3; r++) {
                        for (let c = 0; c < 3; c++) cells.push((br * 3 + r) * 9 + (bc * 3 + c));
                    }
                    for (let i = 0; i < 9; i++) {
                        for (let j = i + 1; j < 9; j++) addQ(cells[i] * 9 + k, cells[j] * 9 + k, 2 * L_CONSTRAINT);
                    }
                }
            }
        }
        for (let r = 0; r < 9; r++) {
            for (let c = 0; c < 9; c++) {
                const val = $('#input_' + r + '_' + c).val();
                if (val) addQ((r * 9 + c) * 9 + (parseInt(val) - 1), (r * 9 + c) * 9 + (parseInt(val) - 1), -L_FIXED);
            }
        }

        let attempt = 0;
        let solved = false;
        
        while (!solved && attempt < 10) {
            attempt++;
            $('#status').text(`Attempt ${attempt}...`).css('color', 'black');
            $(".answer").text('');

            // --- アニーリングパラメータ ---
            // ほどよい性能: cl 0.998, rpt 5000
            const solver = new Bqubo(qubo, { kTinit: 15.0, cl: 0.998, rpt: 5000 });
            const finalState = await solver.solve(null);

            let total = 0;
            for (let n = 0; n < 81; n++) {
                for (let k = 0; k < 9; k++) {
                    if (finalState[n * 9 + k] === 1) {
                        $(`#answer_${Math.floor(n/9)}_${n%9}_${k+1}`).text(k + 1);
                        total++;
                    }
                }
            }

            if (total === 81) {
                $('#status').text(`Success! (${attempt} tries)`).css('color', 'green');
                solved = true;
            } else {
                // 失敗時は少し待ってリトライ
                await new Promise(r => setTimeout(r, 500));
            }
        }
        
        if(!solved) $('#status').text(`Failed. Try again.`).css('color', 'red');
        $btn.prop('disabled', false);
    });
});
</script>
</body>
</html>